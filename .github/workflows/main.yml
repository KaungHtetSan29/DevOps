name: DevOps CI/CD Workflow
on: push

jobs:
  build:
    name: Build and Test DevOps App
    runs-on: ubuntu-22.04

    steps:
      # Step 1: Checkout code
      - name: Checkout repository
        uses: actions/checkout@v2
        with:
          submodules: recursive

      # Step 2: Set up JDK 18
      - name: Set up JDK 18
        uses: actions/setup-java@v2
        with:
          java-version: '18'
          distribution: 'adopt'

      # Step 3: Cache Maven dependencies
      - name: Cache Maven packages
        uses: actions/cache@v3
        with:
          path: ~/.m2/repository
          key: ${{ runner.os }}-maven-${{ hashFiles('**/pom.xml') }}
          restore-keys: |
            ${{ runner.os }}-maven-

      # Step 4: Run unit tests (JUnit 5 compatible)
      - name: Run unit tests
        run: mvn -B clean test

      # Step 5: Build project without running tests again
      - name: Package project
        run: mvn package -DskipTests

      # Step 6: Run Docker Compose
      - name: Run Docker Compose
        run: docker compose up --abort-on-container-exit
